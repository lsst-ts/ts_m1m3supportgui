#!/usr/bin/env python3.8

import signal
import sys

from AccelerometersPageWidget import AccelerometersPageWidget, BoxChartWidget
import SALLog
from VMSGUI import *

import SALComm

from PySide2.QtCore import Slot, Signal, QSettings, QCommandLineParser, Qt
from PySide2.QtWidgets import QApplication, QMainWindow, QDockWidget

from asyncqt import QEventLoop, asyncClose
import asyncio


class EUI(QMainWindow):
    def __init__(self, system):
        super().__init__()

        systems = ["M1M3", "M2", "CAMERAROTATOR"]

        self.comms = [
            SALComm.create("MTVMS", index=index, manual={"data": {"queue_len": 400}})
            for index in range(1, 4)
        ]

        logDock = SALLog.Dock(self.comms)

        menuBar = self.menuBar()
        showMenu = menuBar.addMenu("&Show")
        showMenu.addSeparator()
        showMenu.addAction(logDock.toggleViewAction())

        self.toolBar = ToolBar()
        self.addToolBar(self.toolBar)

        acWidget = AccelerometersPageWidget(self.comms[0], systems[0], self.toolBar)
        statusBar = StatusBar(f"M1M3:0")
        acWidget.cacheUpdated.connect(statusBar.cacheUpdated)
        self.setStatusBar(statusBar)

        self.addDockWidget(Qt.TopDockWidgetArea, acWidget)

        self.addDockWidget(
            Qt.TopDockWidgetArea, BoxChartWidget("Box 1", self.comms[0].data, 3)
        )
        self.addDockWidget(Qt.BottomDockWidgetArea, logDock)

        self.setMinimumSize(700, 400)

        settings = QSettings("LSST.TS", "VMSGUI")
        try:
            self.restoreGeometry(settings.value("geometry"))
            self.restoreState(settings.value("windowState"))
        except AttributeError:
            self.resize(1000, 700)

    @asyncClose
    async def closeEvent(self, event):
        settings = QSettings("LSST.TS", "VMSGUI")
        settings.setValue("geometry", self.saveGeometry())
        settings.setValue("windowState", self.saveState())
        self.toolBar.storeSettings()
        for comm in self.comms:
            await comm.close()
        super().closeEvent(event)


if __name__ == "__main__":
    # Create the Qt Application
    app = QApplication(sys.argv)

    parser = QCommandLineParser()
    parser.addHelpOption()
    parser.addVersionOption()
    parser.addPositionalArgument(
        "system",
        QApplication.translate("main", "VMS subsystem"),
        "[M1M3|M2|cameraRotator]",
    )
    parser.process(app)

    args = parser.positionalArguments()
    if len(args) > 0:
        system = args[0].upper()
    else:
        system = "M1M3"
    app.setApplicationName(f"VMSGUI {system}")

    loop = QEventLoop(app)
    asyncio.set_event_loop(loop)

    # Create EUI
    eui = EUI(system)
    eui.show()

    def handler(signum, frame):
        print(f"Catching signal {signum}, exiting")
        loop.call_soon(eui.close)

    for signum in [signal.SIGINT, signal.SIGHUP, signal.SIGTERM]:
        signal.signal(signum, handler)

    # Run the main Qt loop
    with loop:
        loop.run_forever()

    # Close application
    sys.exit()
